<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l" crossorigin="anonymous">
</head>
<style>
    table, th, td {
    border: 1px solid black;
    border-collapse: collapse;
    }

    .oggettoUtente{
        background-color: burlywood;
    }

    .centrato{
        text-align: center;
    }

    .stessaRiga{
        display: block;
    }
</style>
<body>
    <h1 class="centrato">DATABASE NOSQL - MONGODB</h1>
    <hr>
    <div>
        <div class="container">
            <h3>Creazione utente</h3>
            <form>
                <div class="form-group">
                  <label for="exampleInputEmail1">Nome</label>
                  <input type="text" class="form-control" id="nome" aria-describedby="emailHelp">
                </div>
                <div class="form-group">
                  <label for="exampleInputPassword1">Cognome</label>
                  <input type="text" class="form-control" id="cognome">
                </div>
                <h5>Data di nascita</h5>
                <div class="row">
                    <div class="col-md-3">
                        <label>Giorno</label>
                        <select name="" id="selectGiorno" class="form-control">
                            <option value="">Giorno</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                            <option value="9">9</option>
                            <option value="10">10</option>
                            <option value="11">11</option>
                            <option value="12">12</option>
                            <option value="13">13</option>
                            <option value="14">14</option>
                            <option value="15">15</option>
                            <option value="16">16</option>
                            <option value="17">17</option>
                            <option value="18">18</option>
                            <option value="19">19</option>
                            <option value="20">20</option>
                            <option value="21">21</option>
                            <option value="22">22</option>
                            <option value="23">23</option>
                            <option value="24">24</option>
                            <option value="25">25</option>
                            <option value="26">26</option>
                            <option value="27">27</option>
                            <option value="28">28</option>
                            <option value="29">29</option>
                            <option value="30">30</option>
                            <option value="31">31</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label>Mese</label>
                        <select name="" id="selectMese" class="form-control">
                            <option value="0">Gennaio</option>
                            <option value="1">Febbraio</option>
                            <option value="2">Marzo</option>
                            <option value="3">Aprile</option>
                            <option value="4">Maggio</option>
                            <option value="5">Giugno</option>
                            <option value="6">Luglio</option>
                            <option value="7">Agosto</option>
                            <option value="8">Settembre</option>
                            <option value="9">Ottobre</option>
                            <option value="10">Novembre</option>
                            <option value="11">Dicembre</option>
                        </select> 
                    </div>
                    <div class="col-md-3">
                        <label for="">Anno</label>
                        <input type="text" name="" id="inputAnno" class="form-control">
                    </div>
                </div>
                <br>
                <div>
                    <h5>Sesso</h5>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="inlineRadioOptions" id="radioMaschio" value="option1">
                        <label class="form-check-label" for="inlineRadio1">Maschio</label>
                      </div>
                      <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="inlineRadioOptions" id="radioFemmina" value="option2">
                        <label class="form-check-label" for="inlineRadio2">Femmina</label>
                      </div>
                </div>
                <br>
                <button type="submit" class="btn btn-primary">Submit</button>
              </form>
              <hr>
              <h3>Visualizza tutti gli utenti in tabella</h3>
              <h5>Ordina per:</h5>
              <select name="" id="selectOrdinamento" class="form-control">
                  <option value="0">Nome e cognome (default)</option>
                  <option value="1">Nome</option>
                  <option value="2">Cognome</option>
                  <option value="3">Età</option>
                  <option value="4">Giorno di nascita</option>
                  <option value="5">Mese di nascita</option>
                  <option value="6">Anno di nascita</option>
              </select>
              <div>
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="inlineRadioOptions" id="radioCrescente" value="option1">
                    <label class="form-check-label" for="inlineRadio1">Crescente</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="inlineRadioOptions" id="radioDecrescente" value="option2">
                    <label class="form-check-label" for="inlineRadio2">Decrescente</label>
                  </div><br>
                  <small>Default: crescente</small>
              </div>
              <br>
              <button type="" onclick="prendiTutti()" class="btn btn-primary">
                  Recupera tutti gli utenti
              </button>
              <br>
              <br>
            <table id="tabellaTuttiUtenti" class="table table-striped table-hover">
                <tr>
                    <th>Nome</th>
                    <th>Cognome</th>
                    <th>Età</th>
                    <th>Giorno</th>
                    <th>Mese</th>
                    <th>Anno</th>
                    <th>Sesso</th>
                </tr>
            </table>
              <hr>
            <div>
                <h3>Trova un utente inserendo nome e cognome</h3>
                <div class="row">
                    <div class="col-md-5">
                        <input type="text" name="" id="nomeCerca" class="form-control">
                    </div>
                    <div class="col-md-5">
                        <input type="text" name="" id="cognomeCerca" class="form-control">
                    </div>
                    <div class="col-md-2">
                        <button onclick="prendiUnUtente()" class="btn btn-primary">Cerca</button>
                    </div>
                </div>
                <br>
                
                
                <div class="card">
                    <h5 class="card-title"><span id="nomeTrovato"> </span> <span id="cognomeTrovato"></span></h5>
                    <p><span id="datiUtenteTrovato"></span></p>
                </div>
            </div>
            <hr>
            <div>
                <h3>Cancella un utente inserendo nome e cognome</h3>
                <div class="row">
                    <div class="col-md-5">
                        <input type="text" name="" id="nomeCancella" class="form-control">
                    </div>
                    <div class="col-md-5">
                        <input type="text" name="" id="cognomeCancella" class="form-control">
                    </div>
                    <div class="col-md-2">
                        <button onclick="cancellaUtente()" class="btn btn-primary">Cancella</button>
                    </div>
                </div>
                <p><span id="risultatoCancella"></span></p>
            </div>
            <br>
            <hr>
            <h3>Statistiche sugli utenti</h3>
            <button class="btn btn-primary" onclick="getStatistiche()">Recupera le statistiche</button>

            <h5>Numero di persone nate per mese</h5>
            <table id="tabellaUtentiPerMese" class="table table-striped table-hover">
                <thead>
                    <th>Mese</th>
                    <th>Numero di persone</th>
                </thead>
            </table>
            <br>
            <h5>Nome delle persone per età</h5>
            <table id="tabellaPersoneEta" class="table table-striped table-hover">
                <thead>
                    <th>Età</th>
                    <th>Persone</th>
                </thead>
            </table>
            <hr>
            <br>
            <button class="btn-primary btn btn-block" onclick="cancellaTutti()" disabled>Cancella tutti gli utenti</button>
            <br>
        </div>
        

    </div>
</body>
    <script src="https://code.jquery.com/jquery-3.6.0.js" integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-Piv4xVNRyMGpqkS2by6br4gNJ7DXjqk09RmUpJ8jgGtD7zP9yug3goQfGII0yAns" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js" integrity="sha384-+YQ4JLhjyBLPDQt//I+STsc9iw4uQqACwlvpslubQzn4u2UU2UFM80nGisd026JF" crossorigin="anonymous"></script>
    <script>
        const formField = document.querySelector('form')
        const nomeField = document.getElementById('nome')
        const cognomeField = document.getElementById('cognome')
        var tuttiUtenti=[]

        formField.addEventListener('submit', register)

        async function register (e) {
            e.preventDefault()

            let nome = nomeField.value
            let cognome = cognomeField.value
            let giorno = document.getElementById("selectGiorno").value
            let mese=document.getElementById("selectMese").value
            let anno=document.getElementById("inputAnno").value
            let sesso
            if (document.getElementById("radioMaschio").checked==true) sesso="maschio"
            else sesso="femmina"

            if (nome != '' && cognome != '') {

                let data = { nome: nome, cognome: cognome, giorno, mese, anno, sesso }

                const result = await fetch('/registernewuser', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'Application/JSON'
                    },
                    body: JSON.stringify(data),
                    
                }).then(res => res.json())
                .then(result=>{
                    if (result.stato=="successo"){
                        alert("Utente creato")
                        document.getElementById("selectMese").value=""
                        document.getElementById("inputAnno").value=""
                        document.getElementById("selectGiorno").value=""
                        document.getElementById("nome").value=""
                        document.getElementById("cognome").value=""
                        if (document.getElementById("radioMaschio").checked==true) document.getElementById("radioMaschio").checked==false
                        else document.getElementById("radioFemmina").checked==false
                    }
                })
                .catch(err=>console.log(err))
            }
        }

        const prendiTutti=()=>{
            let ordinamento=document.getElementById("selectOrdinamento").value
            let ordine

            if (document.getElementById("radioCrescente").checked==true) ordine=1
            else if (document.getElementById("radioDecrescente").checked==true) ordine=-1
            else ordine=1


            fetch("/getallusers",{
                method: "POST",
                headers:{
                    "Content-Type": "Application/JSON"
                },
                body: JSON.stringify({
                    ordinamento,
                    ordine
                })
            })
            .then(result=>result.json())
            .then(result=>{
                tuttiUtenti=result

                for (i=0;i<tuttiUtenti.length;i++){
                    if (tuttiUtenti[i].mese==0) tuttiUtenti[i].mese="Gennaio"
                    if (tuttiUtenti[i].mese==1) tuttiUtenti[i].mese="Febbraio"
                    if (tuttiUtenti[i].mese==2) tuttiUtenti[i].mese="Marzo"
                    if (tuttiUtenti[i].mese==3) tuttiUtenti[i].mese="Aprile"
                    if (tuttiUtenti[i].mese==4) tuttiUtenti[i].mese="Maggio"
                    if (tuttiUtenti[i].mese==5) tuttiUtenti[i].mese="Giugno"
                    if (tuttiUtenti[i].mese==6) tuttiUtenti[i].mese="Luglio"
                    if (tuttiUtenti[i].mese==7) tuttiUtenti[i].mese="Agosto"
                    if (tuttiUtenti[i].mese==8) tuttiUtenti[i].mese="Settembre"
                    if (tuttiUtenti[i].mese==9) tuttiUtenti[i].mese="Ottobre"
                    if (tuttiUtenti[i].mese==10) tuttiUtenti[i].mese="Novembre"
                    if (tuttiUtenti[i].mese==11) tuttiUtenti[i].mese="Dicembre"
                }

                riempiTabella()
            })
            .catch(err=>console.log(err))
        }

        const prendiUnUtente=()=>{
            document.getElementById("nomeTrovato").innerText=""
            document.getElementById("cognomeTrovato").innerText=""  
            fetch("/getoneuser",{
                method: "POST",
                headers:{
                    "Content-Type": "Application/JSON"
                },
                body: JSON.stringify({
                    nome: document.getElementById("nomeCerca").value,
                    cognome: document.getElementById("cognomeCerca").value
                })
            })
            .then(result=>result.json())
            .then(result=>{
                if (result.stato=="non trovato"){
                    document.getElementById("nomeTrovato").innerText="Impossibile trovare questo utente"
                    document.getElementById("datiUtenteTrovato").innerHTML="Nessun dato disponibile"
                }
                else {
                    result.mese+=1
                    document.getElementById("nomeTrovato").innerText=result.nome
                    document.getElementById("cognomeTrovato").innerText=result.cognome
                    document.getElementById("datiUtenteTrovato").innerHTML="Età: "+result.eta+"<br>Data di nascita: "+result.giorno+"/"+result.mese+"/"+result.anno+"<br>Sesso: "+result.sesso                 
                }

            })
            .catch(err=>console.log(err))
        }

        const cancellaUtente=()=>{
            fetch("/removeoneuser",{
                method: "POST",
                headers:{
                    "Content-Type": "Application/JSON"
                },
                body: JSON.stringify({
                    nome: document.getElementById("nomeCancella").value,
                    cognome: document.getElementById("cognomeCancella").value
                })
            })
            .then(result=>result.json())
            .then(result=>{
                if (result.stato=="non trovato"){
                    alert("Impossibile trovare questo utente")
                }
                else {
                    alert("Utente eliminato")               
                }

            })
            .catch(err=>console.log(err))
        }

        const cancellaTutti=()=>{
            fetch("/removeallusers",{
                method: "GET",
            })
            .then(result=>result.json())
            .then(result=>{
                if (result.stato=="errore"){
                    alert("Impossibile cancellare tutti gli utenti")
                }
                else {
                    alert("Tutti gli utenti sono stati eliminati")               
                }

            })
            .catch(err=>console.log(err))
        }

        const getStatistiche=()=>{
            fetch("/statistiche",{
                method: "GET"
            })
            .then(result=>result.json())
            .then(result=>{
                let tabella=document.getElementById("tabellaUtentiPerMese")
                let dimensioneTabella=tabella.rows.length

                for (i=0;i<dimensioneTabella;i++){
                    tabella.deleteRow(-1)
                }

                let riga=tabella.insertRow(-1)
                let mese=riga.insertCell(0)
                let numero=riga.insertCell(1)

                mese.innerHTML="<b>Mese</b>"
                numero.innerHTML="<b>Numero di persone</b>"
                for (i=0;i<result.length;i++){
                    riga=tabella.insertRow(-1)
                    mese=riga.insertCell(0)
                    numero=riga.insertCell(1)

                    mese.innerText=result[i]._id
                    numero.innerText=result[i].persone
                }
            })
            .catch(err=>console.log(err))

            fetch("/statistiche_nome",{
                method: "GET"
            })
            .then(result=>result.json())
            .then(result=>{
                console.log(result)
                let tabella=document.getElementById("tabellaPersoneEta")
                let dimensioneTabella=tabella.rows.length

                for (i=0;i<dimensioneTabella;i++){
                    tabella.deleteRow(-1)
                }

                let riga=tabella.insertRow(-1)
                let eta=riga.insertCell(0)
                let persone=riga.insertCell(1)

                eta.innerHTML="<b>Età</b>"
                persone.innerHTML="<b>Persone</b>"
                for (i=0;i<result.length;i++){
                    riga=tabella.insertRow(-1)
                    eta=riga.insertCell(0)
                    persone=riga.insertCell(1)

                    eta.innerText=result[i]._id
                    for (j=0;j<result[i].persone.length;j++){
                        persone.innerHTML=persone.innerHTML+result[i].persone[j]+"<br>"
                    }
                }
            })
        }

        const riempiTabella=()=>{
            let tabella=document.getElementById("tabellaTuttiUtenti")
            let dimensione=tabella.rows.length

            for (let i=0;i<dimensione;i++){
                tabella.deleteRow(-1)
            }

            let riga=tabella.insertRow(-1)
            let nome=riga.insertCell(0)
            let cognome=riga.insertCell(1)
            let eta=riga.insertCell(2)
            let giorno=riga.insertCell(3)
            let mese=riga.insertCell(4)
            let anno=riga.insertCell(5)
            let sesso=riga.insertCell(6)

            nome.innerHTML="<b>Nome</b>"
            cognome.innerHTML="<b>Cognome</b>"
            eta.innerHTML="<b>Età</b>"
            giorno.innerHTML="<b>Giorno</b>"
            mese.innerHTML="<b>Mese</b>"
            anno.innerHTML="<b>Anno</b>"
            sesso.innerHTML="<b>Sesso</b>"
            for (let i=0;i<tuttiUtenti.length;i++){
                let riga=tabella.insertRow(-1)
                let nome=riga.insertCell(0)
                let cognome=riga.insertCell(1)
                let eta=riga.insertCell(2)
                let giorno=riga.insertCell(3)
                let mese=riga.insertCell(4)
                let anno=riga.insertCell(5)
                let sesso=riga.insertCell(6)

                nome.innerText=tuttiUtenti[i].nome
                cognome.innerText=tuttiUtenti[i].cognome
                eta.innerText=tuttiUtenti[i].eta
                giorno.innerText=tuttiUtenti[i].giorno
                mese.innerText=tuttiUtenti[i].mese
                anno.innerText=tuttiUtenti[i].anno
                sesso.innerText=tuttiUtenti[i].sesso
            }
        }
    </script>
</html>